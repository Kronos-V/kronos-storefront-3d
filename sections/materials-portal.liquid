{% comment %}
Materials Portal — TLK (stable image version)
- Robust <img> with simple src + srcset + sizes (no CSS vars)
- Works whether images come from Files or Library via image_picker
- Fallback block shown if image URL fails
{% endcomment %}

{% assign cols_d = section.settings.columns_desktop | default: 3 %}
{% assign cols_m = section.settings.columns_mobile | default: 1 %}

{% capture ar_style %}
{% case section.settings.card_ratio %}
  {% when 'square' %}aspect-ratio:1/1;
  {% when 'land' %}aspect-ratio:16/9;
  {% when 'port' %}aspect-ratio:3/4;
  {% else %}{% comment %}auto{% endcomment %}{% endcase %}
{% endcapture %}

<section id="materials-{{ section.id }}" style="padding:clamp(28px,4vw,56px) 0; background:{{ section.settings.bg }}; color:{{ section.settings.text_color }}">
  <style>
    #materials-{{ section.id }} .c{width:min(1200px,92%);margin:0 auto;}
    #materials-{{ section.id }} .t{font-family:'Bodoni Moda',serif;font-size:clamp(28px,4.5vw,48px);line-height:1.1;margin:0 0 8px 0;}
    #materials-{{ section.id }} .s{max-width:65ch;opacity:.9;margin:0 0 28px 0;}

    #materials-{{ section.id }} .g{
      display:grid; gap:clamp(12px,2vw,20px);
      grid-template-columns:repeat({{ cols_m }}, minmax(0,1fr));
    }
    @media (min-width:900px){
      #materials-{{ section.id }} .g{ grid-template-columns:repeat({{ cols_d }}, minmax(0,1fr)); }
    }

    #materials-{{ section.id }} .card{ text-decoration:none; color:inherit; display:block; overflow:hidden; border-radius:18px; position:relative; }
    #materials-{{ section.id }} .media{ position:relative; border-radius:18px; overflow:hidden; background:#0c0c0c; {{ ar_style | strip }} }
    {% if section.settings.card_ratio == 'auto' %}
      #materials-{{ section.id }} .media{ min-height:260px; }
      #materials-{{ section.id }} .media img{ width:100%; height:auto; display:block; object-fit:{{ section.settings.image_fit | default: 'contain' }}; object-position:{{ section.settings.image_focus | default: 'center center' }}; }
    {% else %}
      #materials-{{ section.id }} .media img{ position:absolute; inset:0; width:100%; height:100%; display:block; object-fit:{{ section.settings.image_fit | default: 'cover' }}; object-position:{{ section.settings.image_focus | default: 'center center' }}; }
    {% endif %}

    #materials-{{ section.id }} .glow{ position:absolute; inset:0; border-radius:inherit; pointer-events:none; box-shadow:0 0 0 transparent; transition:box-shadow .35s ease; }
    #materials-{{ section.id }} .ovl{
      position:absolute; inset:0; display:flex; align-items:end; justify-content:space-between;
      padding:clamp(12px,2.2vw,20px);
      background:linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,.55) 100%);
      color:#fff;
    }
    #materials-{{ section.id }} .card:hover{ transform:translateY(-2px); transition:transform .35s ease; }
    #materials-{{ section.id }} .card:hover .glow{ box-shadow:0 20px 60px {{ section.settings.glow | default: 'rgba(16,59,88,.35)' }}; }
    #materials-{{ section.id }} .media::after{ content:""; position:absolute; inset:0; border:1px solid rgba(255,255,255,.06); border-radius:inherit; pointer-events:none; }
  </style>

  <div class="c">
    {% if section.settings.heading != blank %}<h2 class="t">{{ section.settings.heading }}</h2>{% endif %}
    {% if section.settings.subheading != blank %}<p class="s">{{ section.settings.subheading }}</p>{% endif %}

    <div class="g">
      {% for block in section.blocks %}
        {% if block.type == 'card' %}
          {% assign title = block.settings.title %}
          {% assign url = block.settings.url %}
          {% assign img = block.settings.image %}
          {% assign tag = block.settings.tag %}
          {% assign desc = block.settings.desc %}

          <a {% if url != blank %}href="{{ url }}"{% endif %} class="card">
            <div class="media">
              {% if img != blank %}
                {% assign src = img | image_url: width: 1600 %}
                {% comment %}Render a robust responsive image (no CSS vars in sizes).{% endcomment %}
                <img
                  src="{{ src }}"
                  srcset="
                    {{ img | image_url: width: 480 }} 480w,
                    {{ img | image_url: width: 720 }} 720w,
                    {{ img | image_url: width: 960 }} 960w,
                    {{ img | image_url: width: 1200 }} 1200w,
                    {{ img | image_url: width: 1600 }} 1600w"
                  sizes="(min-width:900px) 33vw, 92vw"
                  alt="{{ title | escape }}"
                  loading="lazy">
              {% else %}
                <div style="position:absolute;inset:0;display:grid;place-items:center;opacity:.6;"><span>No image selected</span></div>
              {% endif %}

              <div class="glow"></div>

              <div class="ovl">
                <div>
                  {% if tag != blank %}
                    <span style="display:inline-block;font-size:12px;letter-spacing:.06em;opacity:.8;margin-bottom:6px;background:rgba(255,255,255,.08);padding:.25rem .5rem;border-radius:999px;">{{ tag }}</span>
                  {% endif %}
                  <div style="font-family:'Bodoni Moda',serif;font-size:clamp(18px,2.2vw,28px);line-height:1.1;">{{ title }}</div>
                  {% if desc != blank %}<div style="font-size:14px;opacity:.85;margin-top:6px;max-width:45ch;">{{ desc }}</div>{% endif %}
                </div>
                <div aria-hidden="true" style="font-size:20px;opacity:.9">↗</div>
              </div>
            </div>
          </a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Materials Portal",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Materials" },
    { "type": "textarea", "id": "subheading", "label": "Subheading", "default": "Explore the fibers and finishes behind each piece." },
    { "type": "range", "id": "columns_desktop", "min": 2, "max": 4, "step": 1, "label": "Columns (desktop)", "default": 3 },
    { "type": "select", "id": "columns_mobile", "label": "Columns (mobile)", "default": "1", "options": [{"value":"1","label":"1"},{"value":"2","label":"2"}] },
    { "type": "select", "id": "card_ratio", "label": "Card image ratio", "default": "auto",
      "options": [
        {"value":"auto","label":"Auto (no crop)"},
        {"value":"square","label":"Square"},
        {"value":"land","label":"Landscape 16:9"},
        {"value":"port","label":"Portrait 3:4"}
      ]
    },
    { "type": "select", "id": "image_fit", "label": "Image fit", "default": "cover",
      "options": [
        {"value":"cover","label":"Cover (fill, may crop)"},
        {"value":"contain","label":"Contain (no crop, may letterbox)"}
      ]
    },
    { "type": "text", "id": "image_focus", "label": "Image focus (CSS object-position)", "default": "center center" },
    { "type": "color", "id": "bg", "label": "Background", "default": "#000000" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#F0F0EC" },
    { "type": "text", "id": "glow", "label": "Glow (CSS color/rgba)", "default": "rgba(16,59,88,.35)" }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Material card",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "title", "label": "Title", "default": "Supima® Cotton" },
        { "type": "text", "id": "tag", "label": "Tag (optional)", "default": "Natural Fiber" },
        { "type": "textarea", "id": "desc", "label": "Short description", "default": "Long-staple softness, strength, and sheen." },
        { "type": "url", "id": "url", "label": "Link URL" }
      ]
    }
  ],
  "presets": [{ "name": "Materials Portal" }]
}
{% endschema %}
