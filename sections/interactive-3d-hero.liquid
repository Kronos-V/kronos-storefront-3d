{% comment %}Interactive 3D Hero — robust loader{% endcomment %}
<section class="section-3d-hero" style="position:relative;min-height:70vh">
  {% case section.settings.mode %}
    {% when 'spline' %}
      <div class="spline-embed">{{ section.settings.spline_embed }}</div>

    {% when 'modelviewer' %}
      <model-viewer src="{{ section.settings.model_url }}" alt="{{ section.settings.alt | escape }}"
        ar ar-modes="webxr scene-viewer quick-look" camera-controls interaction-prompt="none" autoplay
        style="width:100%;height:70vh;display:block;background:{{ section.settings.bg | default: '#000' }}"></model-viewer>
      <script defer src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    {% when 'three' %}
      {%- assign hero_js = 'hero-3d.js' | asset_url -%}
      <canvas
        id="hero3d-{{ section.id }}"
        data-hero3d
        data-model="{{ section.settings.three_model_url }}"
        data-env="{{ section.settings.three_env_hdr }}"
        data-exposure="{{ section.settings.exposure | default: 1.0 }}"
        data-autorotate="{{ section.settings.autorotate }}"
        data-speed="{{ section.settings.rotation_speed | default: 0.4 }}"
        style="width:100%;height:70vh;display:block;background:{{ section.settings.bg | default: '#000' }}">
      </canvas>
      <!-- Temporary debug: hides automatically once JS initializes -->
      <div id="tlk-3d-debug-{{ section.id }}" style="position:absolute;inset:auto 0 8px 0;text-align:center;font-size:12px;opacity:.6;">
        Initializing 3D…
      </div>
      <script type="module" src="{{ hero_js }}"></script>
      <script>
        (function(){
          const el = document.getElementById('tlk-3d-debug-{{ section.id }}');
          let tries = 0;
          const t = setInterval(()=>{
            tries++;
            if (window.__TLKHero3DLoaded) { el && (el.style.display='none'); clearInterval(t); }
            if (tries > 40) { el && (el.textContent='3D script not detected'); clearInterval(t); }
          }, 150);
        })();
      </script>

    {% else %}
      <!-- Fallback if mode not set -->
      <div style="height:70vh;display:grid;place-items:center;background:#000;color:#fff;">
        Set Render mode to “Three.js (assets/hero-3d.js)”.
      </div>
  {% endcase %}

  <div class="overlay" style="position:absolute;inset:0;display:flex;align-items:end;pointer-events:none">
    <div style="padding:clamp(16px,3vw,40px);max-width:1200px;margin:auto;color:{{ section.settings.text_color }}">
      <h1 style="font-family:Bodoni Moda, serif;font-size:clamp(28px,5vw,56px);margin:0">{{ section.settings.heading }}</h1>
      <p style="max-width:60ch;opacity:.9">{{ section.settings.subheading }}</p>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Interactive 3D Hero",
  "tag": "section",
  "settings": [
    { "type": "select", "id": "mode", "label": "Render mode",
      "options": [
        { "value": "spline", "label": "Spline embed" },
        { "value": "modelviewer", "label": "Model Viewer (GLB/USDZ)" },
        { "value": "three", "label": "Three.js (assets/hero-3d.js)" }
      ],
      "default": "three"
    },
    { "type": "textarea", "id": "spline_embed", "label": "Spline embed code", "default": "<!-- paste Spline iframe here if you choose 'Spline' mode -->" },
    { "type": "url", "id": "model_url", "label": "Model URL (GLB/USDZ from Files)" },

    { "type": "url", "id": "three_model_url", "label": "Three.js model (GLB)", "info": "Upload .glb in Content → Files and paste URL" },
    { "type": "url", "id": "three_env_hdr", "label": "Environment HDR (optional)", "info": "Upload .hdr and paste URL" },
    { "type": "range", "id": "exposure", "label": "Tone mapping exposure", "min": 0.2, "max": 2.0, "step": 0.1, "default": 1.0 },
    { "type": "checkbox", "id": "autorotate", "label": "Auto-rotate", "default": true },
    { "type": "range", "id": "rotation_speed", "label": "Rotate speed", "min": 0.1, "max": 2.0, "step": 0.1, "default": 0.4 },

    { "type": "color", "id": "bg", "label": "Background", "default": "#000000" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#F0F0EC" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "The Kronos Legacy" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Time Doesn’t Touch This." }
  ],
  "presets": [{ "name": "Interactive 3D Hero" }]
}
{% endschema %}
